<%*
// 選択範囲を取得
const editor = app.workspace.activeLeaf.view.editor;
const selection = editor.getSelection();

// 変換ロジック
function toHalfWidth(str) {
    // [！-～] の範囲でマッチさせつつ、特定の文字だけ除外する
    return str.replace(/[！-～]/g, function(s) {
        // ▼▼▼ 除外設定 ▼▼▼
        // ここに変換したくない文字を追加できます
        if (s === '！' || s === '？' || s === '～') {
            return s; // 全角のまま返す
        }
        // ▲▲▲▲▲▲▲▲▲▲▲▲
        
        return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
    }).replace(/　/g, " "); // 全角スペースは半角へ
}

if (selection) {
    editor.replaceSelection(toHalfWidth(selection));
} else {
    const content = editor.getValue();
    editor.setValue(toHalfWidth(content));
}
%>
